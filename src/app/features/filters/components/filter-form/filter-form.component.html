<form [formGroup]="filterForm" (ngSubmit)="submit()" class="flex flex-column gap-4 py-3">

    <!-- Statut (Style Card comme Challenge) -->
    <div class="flex align-items-center justify-content-between p-3 border-1 surface-border border-round bg-gray-50">
        <div class="flex flex-column gap-1">
            <label for="isActive" class="font-bold cursor-pointer">Statut du filtre</label>
            <small class="text-500">
                {{ filterForm.get('isActive')?.value ? 'Visible sur le site public' : 'Masqué du site public' }}
            </small>
        </div>
        <div class="flex flex-column align-items-end gap-2">
            <p-toggleswitch formControlName="isActive" inputId="isActive" />
            <p-tag [severity]="filterForm.get('isActive')?.value ? 'success' : 'danger'"
                [value]="filterForm.get('isActive')?.value ? 'ACTIF' : 'INACTIF'">
            </p-tag>
        </div>
    </div>

    <!-- URL du Filtre -->
    <div class="flex flex-column gap-2">
        <label for="filterUrl" class="font-bold">Lien du filtre *</label>
        <div class="p-inputgroup">
            <input pInputText id="filterUrl" formControlName="filterUrl"
                [placeholder]="filterForm.get('platform')?.value === 'SNAPCHAT' ? 'https://snapchat.com/unlock/...' : 'https://vm.tiktok.com/...'"
                class="w-full" />
        </div>
        <small class="p-error" *ngIf="filterUrlControl?.errors?.['required'] && filterUrlControl?.touched">
            L'URL est requise
        </small>
    </div>

    <!-- Nom -->
    <div class="flex flex-column gap-2">
        <label for="name" class="font-bold">Nom du filtre *</label>
        <input pInputText id="name" formControlName="name" placeholder="Ex: Filtre Campagne 2026" class="w-full" />
        <small class="p-error" *ngIf="nameControl?.invalid && nameControl?.touched">
            Maximum 100 caractères
        </small>
    </div>

    <!-- Plateforme -->
    <div class="flex flex-column gap-2">
        <label class="font-bold">Plateforme *</label>
        <div class="flex flex-wrap gap-4">
            <div class="flex align-items-center gap-2">
                <p-radioButton name="platform" value="SNAPCHAT" formControlName="platform" inputId="platformSnap">
                </p-radioButton>
                <label for="platformSnap" class="cursor-pointer flex align-items-center gap-2">
                    Snapchat
                </label>
            </div>
            <div class="flex align-items-center gap-2">
                <p-radioButton name="platform" value="TIKTOK" formControlName="platform" inputId="platformTikTok">
                </p-radioButton>
                <label for="platformTikTok" class="cursor-pointer flex align-items-center gap-2">
                    TikTok
                </label>
            </div>
        </div>
    </div>

    <!-- Info Box (Mode Édition) -->
    <div *ngIf="isEditMode && filter" class="flex align-items-start gap-3 p-3 bg-blue-50 text-blue-700 border-round border-1 border-blue-100">
        <i class="pi pi-info-circle text-xl mt-1"></i>
        <div class="flex flex-column gap-1 text-sm">
            <span><strong>Utilisations :</strong> {{ filter.usageCount | number }} fois</span>
            <span><strong>Créé le :</strong> {{ filter.createdAt | date:'dd/MM/yyyy à HH:mm' }}</span>
        </div>
    </div>

    <!-- Image Upload -->
    <div class="flex flex-column gap-2">
        <label class="font-bold">Image du filtre *</label>

        <!-- Zone d'aperçu -->
        <div *ngIf="imagePreview" class="relative mb-2 text-center border-round overflow-hidden border-1 surface-border bg-gray-50 p-3">
            <img [src]="imagePreview" alt="Aperçu" style="max-height: 200px; width: auto; object-fit: contain;" />
            
            <!-- Bouton supprimer l'image -->
            <button type="button" (click)="removeImage()"
                class="absolute top-0 right-0 m-2 p-link w-2rem h-2rem border-circle bg-red-500 text-white flex align-items-center justify-content-center hover:bg-red-600 transition-colors shadow-2"
                pTooltip="Supprimer l'image">
                <i class="pi pi-times"></i>
            </button>
        </div>

        <!-- Bouton Upload -->
        <div *ngIf="!imagePreview">
            <p-fileUpload mode="basic" name="image" accept="image/*" [maxFileSize]="5000000"
                chooseLabel="Choisir une image" chooseIcon="pi pi-image" (onSelect)="onFileSelect($event)"
                [auto]="false" styleClass="p-button-outlined w-full">
            </p-fileUpload>
            <small class="text-500 block mt-1">PNG, JPG, WEBP (max 5MB)</small>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-content-end gap-2 mt-4 pt-3 border-top-1 surface-border">
        <p-button label="Annuler" severity="secondary" [text]="true" icon="pi pi-times" (onClick)="onCancel.emit()">
        </p-button>
        <p-button [label]="isEditMode ? 'Mettre à jour' : 'Créer'" type="submit"
            [icon]="isEditMode ? 'pi pi-check' : 'pi pi-plus'" 
            [disabled]="filterForm.invalid || (!imagePreview && !selectedFile)">
        </p-button>
    </div>

</form>